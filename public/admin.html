<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ChatGPT Server</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <div>
                <h1>üõ°Ô∏è Admin Dashboard</h1>
                <p class="text-muted">Manage your ChatGPT server</p>
            </div>
            <nav class="admin-nav">
                <a href="/">‚Üê Back to Chat</a>
                <button class="btn btn-secondary" id="refreshBtn">
                    üîÑ Refresh
                </button>
                <button class="btn btn-danger" id="logoutBtn">
                    Logout
                </button>
            </nav>
        </header>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Sessions</h3>
                <div class="value" id="activeSessions">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Chats</h3>
                <div class="value" id="totalChats">-</div>
            </div>
            <div class="stat-card">
                <h3>Messages Today</h3>
                <div class="value" id="messagesToday">-</div>
            </div>
            <div class="stat-card">
                <h3>API Requests</h3>
                <div class="value" id="apiRequests">-</div>
            </div>
            <div class="stat-card">
                <h3>Server Uptime</h3>
                <div class="value" id="serverUptime">-</div>
            </div>
        </div>

        <!-- Users Section -->
        <section class="admin-section">
            <div class="admin-section-header">
                <h2>üë• Users</h2>
                <div>
                    <input type="text" placeholder="Search users..." id="userSearch" class="form-group" style="width: 250px; margin: 0; padding: 8px 12px;">
                </div>
            </div>
            <div class="admin-section-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Provider</th>
                            <th>Chats</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr>
                            <td colspan="7" class="text-center text-muted">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Recent Activity Section -->
        <section class="admin-section">
            <div class="admin-section-header">
                <h2>üìä Recent Activity</h2>
            </div>
            <div class="admin-section-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <tr>
                            <td colspan="4" class="text-center text-muted">Loading activity...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Server Configuration -->
        <section class="admin-section">
            <div class="admin-section-header">
                <h2>‚öôÔ∏è Server Configuration</h2>
            </div>
            <div class="admin-section-content">
                <form id="configForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>Default AI Model</label>
                            <select id="defaultModel">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Max Tokens per Request</label>
                            <input type="number" id="maxTokens" value="2048" min="100" max="8000">
                        </div>
                        <div class="form-group">
                            <label>Rate Limit (requests/min)</label>
                            <input type="number" id="rateLimit" value="20" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>System Prompt</label>
                            <textarea id="systemPrompt" rows="4" placeholder="Enter default system prompt..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- API Key Management -->
        <section class="admin-section">
            <div class="admin-section-header">
                <h2>üîë API Key Management</h2>
            </div>
            <div class="admin-section-content">
                <form id="apiKeyForm">
                    <div class="form-group">
                        <label>OpenAI API Key</label>
                        <div style="display: flex; gap: 12px;">
                            <input type="password" id="apiKeyInput" placeholder="sk-..." style="flex: 1;">
                            <button type="button" class="btn btn-secondary" id="toggleApiKey">Show</button>
                            <button type="submit" class="btn btn-primary">Update Key</button>
                        </div>
                        <span class="form-hint">Current key: <span id="currentKeyStatus">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></span>
                    </div>
                </form>
            </div>
        </section>

        <!-- System Logs -->
        <section class="admin-section">
            <div class="admin-section-header">
                <h2>üìã System Logs</h2>
                <button class="btn btn-secondary" id="clearLogsBtn">Clear Logs</button>
            </div>
            <div class="admin-section-content">
                <div id="logsContainer" style="background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 16px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;">
                    <div class="text-muted">Loading logs...</div>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <h2>üîê Admin Login</h2>
            <form id="loginForm">
                <div class="form-error" id="loginError"></div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary btn-block">Login</button>
            </form>
        </div>
    </div>

    <script>
        // State
        let isAuthenticated = false;
        let authToken = localStorage.getItem('adminToken');

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const toastContainer = document.getElementById('toastContainer');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
        });

        // Check authentication
        async function checkAuth() {
            if (!authToken) {
                showLoginModal();
                return;
            }

            try {
                const response = await fetch('/admin/verify', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    isAuthenticated = true;
                    hideLoginModal();
                    loadDashboard();
                } else {
                    localStorage.removeItem('adminToken');
                    authToken = null;
                    showLoginModal();
                }
            } catch (error) {
                showToast('Connection error', 'error');
                showLoginModal();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadDashboard);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Config form
            document.getElementById('configForm').addEventListener('submit', saveConfig);

            // API key form
            document.getElementById('apiKeyForm').addEventListener('submit', updateApiKey);

            // Toggle API key visibility
            document.getElementById('toggleApiKey').addEventListener('click', toggleApiKeyVisibility);

            // Clear logs
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);

            // User search
            document.getElementById('userSearch').addEventListener('input', debounce(searchUsers, 300));
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            loginError.textContent = '';

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    authToken = data.token || 'admin-session';
                    localStorage.setItem('adminToken', authToken);
                    isAuthenticated = true;
                    hideLoginModal();
                    loadDashboard();
                    showToast('Login successful', 'success');
                } else {
                    loginError.textContent = data.error || 'Invalid credentials';
                }
            } catch (error) {
                loginError.textContent = 'Connection error';
            }
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            isAuthenticated = false;
            showLoginModal();
            showToast('Logged out', 'success');
        }

        // Load dashboard data
        async function loadDashboard() {
            loadStats();
            loadUsers();
            loadActivity();
            loadLogs();
            loadConfig();
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/admin/stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalUsers').textContent = stats.totalUsers || '0';
                    document.getElementById('activeSessions').textContent = stats.activeSessions || '0';
                    document.getElementById('totalChats').textContent = stats.totalChats || '0';
                    document.getElementById('messagesToday').textContent = stats.messagesToday || '0';
                    document.getElementById('apiRequests').textContent = stats.apiRequests || '0';
                    document.getElementById('serverUptime').textContent = formatUptime(stats.uptime || 0);
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load users
        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            
            try {
                const response = await fetch('/admin/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const users = await response.json();
                    
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${escapeHtml(user.name || '-')}</td>
                            <td>${escapeHtml(user.email)}</td>
                            <td><span class="badge ${user.google_id ? 'badge-success' : 'badge-warning'}">${user.google_id ? 'Google' : 'Email'}</span></td>
                            <td>${user.chatCount || 0}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>
                                <button class="icon-btn" onclick="viewUser(${user.id})" title="View">üëÅÔ∏è</button>
                                <button class="icon-btn delete" onclick="deleteUser(${user.id})" title="Delete">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Failed to load users</td></tr>';
            }
        }

        // Load activity
        async function loadActivity() {
            const tbody = document.getElementById('activityTable');
            
            try {
                const response = await fetch('/admin/activity', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const activities = await response.json();
                    
                    if (activities.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent activity</td></tr>';
                        return;
                    }

                    tbody.innerHTML = activities.map(activity => `
                        <tr>
                            <td>${formatTime(activity.timestamp)}</td>
                            <td>${escapeHtml(activity.user || 'System')}</td>
                            <td><span class="badge badge-${getActivityBadge(activity.action)}">${activity.action}</span></td>
                            <td>${escapeHtml(activity.details || '-')}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Failed to load activity</td></tr>';
            }
        }

        // Load logs
        async function loadLogs() {
            const container = document.getElementById('logsContainer');
            
            try {
                const response = await fetch('/admin/logs', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const logs = await response.json();
                    
                    if (logs.length === 0) {
                        container.innerHTML = '<div class="text-muted">No logs available</div>';
                        return;
                    }

                    container.innerHTML = logs.map(log => {
                        const levelColor = {
                            'INFO': 'var(--accent-primary)',
                            'WARN': 'var(--accent-warning)',
                            'ERROR': 'var(--accent-danger)'
                        }[log.level] || 'var(--text-secondary)';
                        
                        return `<div style="margin-bottom: 8px;">
                            <span style="color: var(--text-muted)">[${formatTime(log.timestamp)}]</span>
                            <span style="color: ${levelColor}; font-weight: 600;">[${log.level}]</span>
                            <span>${escapeHtml(log.message)}</span>
                        </div>`;
                    }).join('');
                    
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                container.innerHTML = '<div class="text-muted">Failed to load logs</div>';
            }
        }

        // Load config
        async function loadConfig() {
            try {
                const response = await fetch('/admin/config', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('defaultModel').value = config.model || 'gpt-3.5-turbo';
                    document.getElementById('maxTokens').value = config.maxTokens || 2048;
                    document.getElementById('rateLimit').value = config.rateLimit || 20;
                    document.getElementById('systemPrompt').value = config.systemPrompt || '';
                    
                    if (config.hasApiKey) {
                        document.getElementById('currentKeyStatus').textContent = 'Configured ‚úì';
                    }
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Save config
        async function saveConfig(e) {
            e.preventDefault();

            const config = {
                model: document.getElementById('defaultModel').value,
                maxTokens: parseInt(document.getElementById('maxTokens').value),
                rateLimit: parseInt(document.getElementById('rateLimit').value),
                systemPrompt: document.getElementById('systemPrompt').value
            };

            try {
                const response = await fetch('/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showToast('Configuration saved', 'success');
                } else {
                    showToast('Failed to save configuration', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // Update API key
        async function updateApiKey(e) {
            e.preventDefault();

            const apiKey = document.getElementById('apiKeyInput').value;
            if (!apiKey) {
                showToast('Please enter an API key', 'error');
                return;
            }

            try {
                const response = await fetch('/admin/apikey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ apiKey })
                });

                if (response.ok) {
                    showToast('API key updated', 'success');
                    document.getElementById('apiKeyInput').value = '';
                    document.getElementById('currentKeyStatus').textContent = 'Configured ‚úì';
                } else {
                    showToast('Failed to update API key', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // Toggle API key visibility
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            const btn = document.getElementById('toggleApiKey');
            
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        }

        // Clear logs
        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs?')) return;

            try {
                const response = await fetch('/admin/logs', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    document.getElementById('logsContainer').innerHTML = '<div class="text-muted">Logs cleared</div>';
                    showToast('Logs cleared', 'success');
                }
            } catch (error) {
                showToast('Failed to clear logs', 'error');
            }
        }

        // Search users
        async function searchUsers() {
            const query = document.getElementById('userSearch').value;
            // For now, just filter client-side (can be enhanced with server-side search)
            loadUsers();
        }

        // View user
        function viewUser(userId) {
            // Could open a modal with user details
            alert(`View user ${userId} - Feature coming soon`);
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showToast('User deleted', 'success');
                    loadUsers();
                } else {
                    showToast('Failed to delete user', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // Modal functions
        function showLoginModal() {
            loginModal.classList.add('show');
        }

        function hideLoginModal() {
            loginModal.classList.remove('show');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }

        // Utility functions
        function formatUptime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
            return `${Math.floor(seconds / 86400)}d`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString();
        }

        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleTimeString();
        }

        function getActivityBadge(action) {
            const badges = {
                'login': 'success',
                'logout': 'warning',
                'register': 'success',
                'chat': 'success',
                'error': 'danger'
            };
            return badges[action] || 'warning';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
